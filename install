#!/bin/bash
set -e

if [[ $EUID !=  0 ]]; then
	echo "You must run this as root!"
	exit 1
fi

if [[ ! -e /etc/conf.d/mediaserver ]]; then
	echo "Please create /etc/conf.d/mediaserver before running this!"
	echo "An example can be found in this folder"
	exit 1
fi

source /etc/conf.d/mediaserver

dir="$(dirname "$(readlink -f "$0")")"

mkdir -p /usr/lib/mediaserver
rsync -r "$dir/files/mediaserver/" /usr/lib/mediaserver/

mkdir -p /etc/cron.d
cp "$dir/files/mediaserver.service" /etc/systemd/system/mediaserver.service
cp "$dir/files/check-mediaserver.cron" "/etc/cron.d/check-mediaserver.cron"
cp "$dir/files/restart-mediaserver.cron" "/etc/cron.d/restart-mediaserver.cron"

mkdir -p /etc/samba
cp "$dir/files/smb.conf" "/etc/samba/smb.conf"
sed -i "s|__STORAGE_DIR__|$STORAGE_DIR|g" /etc/samba/smb.conf

systemctl daemon-reload
systemctl enable mediaserver
systemctl status smbd &>/dev/null && systemctl restart smbd
